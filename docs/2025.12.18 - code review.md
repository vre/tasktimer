> Do complete code review on @TaskTimer.html in association with AGENTS.md
  ⎿  Read TaskTimer.html (2262 lines)

⏺ superpowers:code-reviewer(Code review TaskTimer.html)
  ⎿  Done (1 tool use · 56.4k tokens · 2m 8s)

⏺ Code Review Summary: TaskTimer.html

  Project Context (from AGENTS.md)

  - Single HTML file architecture with embedded CSS/JS - correctly followed
  - ClockLogic (pure functions), state (mutable), el (DOM refs) - architecture matches
  - Tests exist in tests/clock.test.js - important for validating fixes

  ---
  Critical Issues (Must Fix)

  | #   | Issue          | Lines     | Description                                                                      |
  |-----|----------------|-----------|----------------------------------------------------------------------------------|
  | 1   | Race Condition | 1546      | start() can be called multiple times rapidly, creating overlapping timers        |
  | 2   | Memory Leak    | 1509      | previewAnimate() sets previewFrame = null without calling cancelAnimationFrame() |
  | 3   | XSS Risk       | 1947-1950 | URL hash time parameter assigned to input without validation                     |

  High Priority Issues

  | #   | Issue          | Lines     | Description                                                        |
  |-----|----------------|-----------|--------------------------------------------------------------------|
  | 4   | Memory Leak    | 1437-1449 | overtimeInterval only cleaned inside if (state.completed) block    |
  | 5   | Memory Leak    | 893-913   | requestWakeLock() adds listeners without cleanup on repeated calls |
  | 6   | Timer Accuracy | 933-938   | Worker checks every 500ms - up to half-second delay on completion  |
  | 7   | PiP Race       | 2128-2133 | updatePip() animation frame not cancelled on exit                  |

  Medium Priority Issues

  | #   | Issue            | Lines     | Description                                                 |
  |-----|------------------|-----------|-------------------------------------------------------------|
  | 8   | A11y             | 1372      | No screen reader announcement when timer completes          |
  | 9   | Security         | 675-686   | Cookie values should validate against \n\r; before encoding |
  | 10  | Input Validation | 538       | parseInput() should reject inputs > 20 chars                |
  | 11  | Global Exposure  | 1022      | window.state exposed in production (security/debug concern) |
  | 12  | Code Duplication | 1730-1794 | Mode/mark button handlers share identical logic             |
  | 13  | A11y             | CSS       | Missing custom :focus styles for keyboard navigation        |

  Low Priority Issues

  | #   | Issue                      | Description                              |
  |-----|----------------------------|------------------------------------------|
  | 14  | No beforeunload cleanup    | Timers/workers not cleaned on page exit  |
  | 15  | DOM thrashing              | wedgeLayer.innerHTML = '' on every frame |
  | 16  | Inconsistent var/let/const | Mix throughout codebase                  |
  | 17  | Touch tooltips             | CSS :hover tooltips don't work on mobile |

  ---
  Positive Highlights

  The code demonstrates excellent practices aligned with AGENTS.md:

  - Clean architecture: ClockLogic pure functions are testable (matches documented pattern)
  - Accessibility: ARIA labels, keyboard nav, screen reader support, roles
  - Feature detection: Graceful degradation for Wake Lock, PiP, Notifications
  - Web Worker: Background timer continues in throttled tabs
  - PWA ready: Notifications, badges, manifest, service worker hooks
  - State management: Single state object as documented

  ---
  Recommended Fix Order

  Per AGENTS.md guidelines ("NO BUGFIX before regression test"):

  1. Write tests first for the race condition and memory leaks in tests/clock.test.js
  2. Fix critical issues 1-3
  3. Refactor to clean code principles (dedupe button handlers, consistent declarations)
  4. Update docs if any API changes